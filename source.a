;Comandare in faza a unui tiristor pentru a efectua
;redresare monoalternanta
;Bejdak Martina, Balanescu Adrian, Chirap Andrei - E115
;Programul functioneaza
	
	ORG 0000H
	SJMP PP
	ORG 000BH
	SJMP TIM0
	ORG 001BH
	SJMP TIM1

	ORG 100H
MAIN:	ACALL INIT	;apelare subrutina de initializare
 	SJMP $		;bucla de asteptare

INIT:	CLR EA		;dezactivare globala a intreruperilor
	MOV TMOD, #11H	;configurare Timer0 si Timer1 in mod de lucru 1 pe 16b, temporizator cu declansare soft

	;citire Talfa din memoria externa de la adresa 300h in R1
	
	MOV DPTR, #300H
	MOVX R1, @DPTR	; R1 = Talfa
	
	;end citire din mem externa

	;verificare limite Talfa 1--9ms TODO
	; if Talfa >= limita inferioara -> ok else Talfa = Talfaminim
	; if Talfa <= limita superioara -> ok else Talfa = Talfamaxim
	;end verificare

	;transformare Talfa (1--9ms) in valori ptr TL0, TH0 -- TODO
	; n = 65535 - Talfa * 1000
	;end transformare

	MOV TL0, #9BH	;LSB pentru Talfa contorizat de timer0
	MOV TH0, #0FFH	;MSB pentru Talfa contorizat de timer0

	MOV TL1, #0DFH	;LSB pentru T contorizat de timer1
	MOV TH1, #0B1H	;MSB pentru T contorizat de timer1
	
	MOV R0, #0	;contor stare timer1

	SETB ET0	;validare intrerupere timer0
	SETB ET1	;validare intrerupere timer1

	MOV P1, #0H	;initializare port0 cu valoarea 0

	SETB TR0	;pornire timer0
	SETB TR1	;pornire timer1

	SETB EA		;activare globala intreruperi
	RET

	ORG 250H
TIM0:	CLR TR0		;dezactivare timer0
	CJNE R0, #0, state1
	CJNE R0, #1, state0
	RETI
	
state0:	SETB P1.1	;activare impuls pentru tiristor
	MOV TL0, #17H	;LSB pentru Timpuls contorizat de timer0, Timpuls = 1ms
	MOV TH0, #0FCH	;MSB pentru Timpuls contorizat de timer0
	SETB TR0	;pornire contorizare Ti 
	MOV R0, #1
	
	RETI

state1:	CLR P1.1	;dezactivare impuls pentru tiristor
	MOV R0, #0

	RETI
	

	ORG 300H
TIM1:	CLR TR0
	CLR TR1
	MOV TL0, #9BH	;LSB pentru Talfa contorizat de timer0, Talfa = 0.1ms
	MOV TH0, #0FFH	;MSB pentru Talfa contorizat de timer0
	
        MOV TL1, #0DEH	;LSB pentru T contorizat de timer1
	MOV TH1, #0B1H	;MSB pentru T contorizat de timer1

	MOV R0, #0	;contor stare timer1
	
	SETB TR0	;pornire timer0
	SETB TR1	;pornire timer1

	RETI


	END
